import streamlit as st
import google.generativeai as genai
from quran_utils import load_quran_db, search_multi_roots_tool
import story_agent  # ุงุณุชุฏุนุงุก ูููู ุงููุตุฉ ุงูุฐู ุจูููุงู ุณุงุจูุงู

# ==========================================
# 1. ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ูุงููุงุฌูุฉ ุงูุนุฑุจูุฉ
# ==========================================
st.set_page_config(
    page_title="ูุญูู ุงููุณุงู ุงูุนุฑุจู ุงููุจูู",
    page_icon="๐",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ูุฑุถ ุงูุงุชุฌุงู ูู ุงููููู ูููุณุงุฑ (RTL) ูุชูุณูู ุงูุฎุทูุท
st.markdown("""
<style>
    .stApp { direction: rtl; text-align: right; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    div[data-testid="stChatMessage"] { direction: rtl; text-align: right; background-color: #f7f9fc; border: 1px solid #e0e0e0; border-radius: 12px; }
    div[data-testid="stSidebar"] { text-align: right; }
    h1, h2, h3, p, label, .stTextInput, .stMarkdown { text-align: right; }
    .stStatus { direction: rtl; text-align: right; }
    code { direction: ltr; text-align: left; }
</style>
""", unsafe_allow_html=True)

# ุงูุชุฃูุฏ ูู ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ูู ุงูููู ุงูุขุฎุฑ)
if load_quran_db():
    st.sidebar.success("โ ูุงุนุฏุฉ ุจูุงูุงุช ุงููุตุญู ูุชุตูุฉ.")
else:
    st.sidebar.error("โ๏ธ ูุดู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช (ุชุญูู ูู quran_utils.py)")

# ==========================================
# 2. ุงูุนูู ุงููุฏุจุฑ (Analyst System Prompt) - ูุชุถูู ุงููุชุงุจ ูุงููุงู
# ==========================================
ANALYST_PROMPT = """
### ุงููููุฉ ูุงููููุฉ:
ุฃูุช "ูุญูู ุงููุณุงู ุงูุนุฑุจู ุงููุจูู"ุ ูููู ุฐูู ูุชุฎุตุต ูู ุงูุชูููู ุงูุนููู ูููุต ุงููุฑุขูู. ูุฑุฌุนูุชู ุงูุญุตุฑูุฉ ูู ูููุฌูุฉ "ููุงููู" (ุฏ. ููุณู ุฃุจู ุนูุงุฏ) ููุชุงุจ "ุงูููุงุนุฏ ุงููุจุฑู ููุณุงู ุงูุนุฑุจู ุงููุจูู".
ูููุชู: ุฅุนุงุฏุฉ ุจูุงุก ุงููุนูู ุงููุฑุขูู ุงุณุชูุงุฏุงู ุฅูู "ููุฒูุงุก ุงูุญุฑู" ู"ุงูุณูู ุงูููููุฉ"ุ ูุน ุชุฌุงูู ุงููุฑููุงุช ุงูุชุงุฑูุฎูุฉ ูุงูุชุฑุงุฏู ุงููุบูู ุชูุงูุงู.

---
### ุฃููุงู: ุงูุฏุณุชูุฑ ุงูุชุดุบููู (ุงูููุงุนุฏ ุงููุจุฑู):
1. **ุงูุตูุช ูู ุงููุนูู:** ุงููุนูู ูููู ูู "ุงูุญุฑู" (ุงูุตูุช) ูุญุฑูุชูุ ูููุณ ูู ุงููููุฉ ุงูุงุตุทูุงุญูุฉ.
2. **ูุง ููุชุฑุงุฏู:** ูุง ููุฌุฏ ูููุชุงู ุจููุณ ุงููุนูู. (ุฎูู $\neq$ ุฎุดูุฉ). ูู ุงุฎุชูุงู ูู ุงููุจูู ูู ุงุฎุชูุงู ูู ุงููุนูู.
3. **ุงูุชุฌุฑูุฏ ูุงูุนุงูููุฉ:** ุญูู ุงูุฃุณูุงุก ุงูุชุงุฑูุฎูุฉ (ูุฑุนููุ ูุฑูุด) ุฅูู "ุฃููุงุท ุณููููุฉ". ุญูู ุงูุทููุณ ุฅูู "ููุงููู ููุนูุฉ".
4. **ุงููุฑุขู ููุณุฑ ููุณู:** ุงุนุชูุฏ ุนูู ูุชุงุฆุฌ "ุงููุณุญ ุงููุฑุขูู" ุงููุฑููุฉ ูู ุงููุฏุฎูุงุช ูููู ุงูุงุณุชุฎุฏุงู ุงููุงุฏู ูููููุฉ ูุจู ุชุฌุฑูุฏูุง.

---
### ุซุงููุงู: ูุนุฌู ููุฒูุงุก ุงูุญุฑูุงุช (ุงูุชุดููู) - ูู ุงููุชุงุจ:
*   **ุงููุชุญุฉ (ู):** ุทุงูุฉ ุฏุงูุนุฉุ ูุงุนู ุธุงูุฑุ ุญุฑูุฉ ููุฃุนูู ุฃู ููุฎุงุฑุฌุ ุจุฏุงูุฉ ุญุฏุซ.
*   **ุงูุถูุฉ (ู):** ุฌูุนุ ุถูุ ุฃูุฑุ ุฅุญุงุทุฉุ ุชูุฌูู ุทุงูุฉ (ูุซู "ููู").
*   **ุงููุณุฑุฉ (ู):** ุทุงูุฉ ูุฎููุฉุ ุจุงุทูุ ูุชูุฌุฉุ ุดูุก ุชู ูุงูุชูู ุฃุซุฑู ููุฏุงุฎู.
*   **ุงูุณููู (ู):** ุชูููุ ูุจุญุ ููุงูุฉ ูุฑุญูุฉุ ุฅุนุฏุงุฏ ูุงูุทูุงู ุฌุฏูุฏ.
*   **ุงูุดุฏุฉ (ู):** ุชูุฑุงุฑุ ุตุนูุจุฉุ ุซููุ ุจุฐู ุฌูุฏ ูุถุงุนู ูู ุงููุนู.

---
### ุซุงูุซุงู: ูุนุฌู ููุฒูุงุก ุงูุญุฑูู (ุงูุตูุงูุช) - ุงููุฑุฌุน ุงูุญุตุฑู:
*ุนููู ุงุณุชุฎุฏุงู ูุฐู ุงูุฏูุงูุงุช ุงูุฏูููุฉ ูู ุชูููู ุงููููุงุช:*

*   **ุก (ุงูููุฒุฉ):** ุทุงูุฉ ุฏุงูุนุฉุ ููุทุฉ ุงูุทูุงูุ ุจุฏุงูุฉ ุธููุฑุ ุฃู ูุทุน ุญุงุณู.
*   **ุง (ุงูุฃูู):** ุธููุฑ ุชุงูุ ุงูุชุฏุงุฏุ ุงุณุชูุงูุฉุ ูุงุนู ูุฑุฆู (ุนูู).
*   **ุจ (ุงูุจุงุก):** ูุนุงุกุ ุณุจุจุ ุจุฏุงูุฉุ ุงุญุชูุงุกุ ุถุบุท ูุคุฏู ูุงููุฌุงุฑ (ุงูุจุซุงู).
*   **ุช (ุงูุชุงุก):** ุชูุงุฑุจุ ุชูุงูุณุ ุชุชุงุจุนุ ุงููุชุงุญ (ูุซู ุงูุชุงุก ุงููุจุณูุทุฉ).
*   **ุซ (ุงูุซุงุก):** ุชูุงุซุฑุ ุชุฌูุน ูู ูุชูุงุซุฑุ ุงูุชุดุงุฑ ูุซูู (ูุซู ุงูุซุฑู).
*   **ุฌ (ุงูุฌูู):** ุฌูุนุ ุชูุชูุ ุถูุ ุดูุก ุจุฏุงุฎู ุดูุก (ุฌููู/ุฌูู).
*   **ุญ (ุงูุญุงุก):** ุงุญุชูุงุก ุญุงุฏุ ุญุฑุงุฑุฉุ ุญูุงุฉุ ุงููุนุงูุ ุงูุชุฏุงุฏ ูุง ููุงุฆู.
*   **ุฎ (ุงูุฎุงุก):** ุฅุฎุฑุงุฌุ ุชุฎููุตุ ุฅุฎูุงุกุ ุฎุฑูุฌ ุจุฎุดููุฉ ูู ูููู.
*   **ุฏ (ุงูุฏุงู):** ุฏูุนุ ูุจุณุ ุฏูุงูุฉุ ุญุฑูุฉ ููุฌูุฉ ูู ุงุชุฌุงู ูุงุญุฏ.
*   **ุฐ (ุงูุฐุงู):** ููุงุฐุ ุชุฐุจุฐุจุ ุญุฑูุฉ ูุณุชูุฑุฉ ุณุฑูุนุฉ (ูุซู ุงูุฐุจุฐุจุฉ).
*   **ุฑ (ุงูุฑุงุก):** ุชูุฑุงุฑุ ุชุฑุฏุฏุ ุงูุชุดุงุฑุ ุชุญูู ูุชุฑุชูุจ (ูุซู ุงูุฑุจ).
*   **ุฒ (ุงูุฒุงู):** ุงูุชุฒุงุฒุ ุฃุฒูุฒุ ููุฉ ุฏุงูุนุฉ ูู ุญูุฒ ุถูู.
*   **ุณ (ุงูุณูู):** ุณุฑูุงูุ ุจุญุซุ ุชุญุณุณุ ุชุฏูู ูุงุนู (ูุซู ุงููุงุก/ุงูููุงุก).
*   **ุด (ุงูุดูู):** ุชูุดูุ ุงูุชุดุงุฑ ูุงุณุนุ ุชุดุนุจ ูู ุงุชุฌุงูุงุช ูุชุนุฏุฏุฉ.
*   **ุต (ุงูุตุงุฏ):** ุชุตุงุฏูุ ุตูุงุจุฉุ ุตูุฑูุฑุฉุ ุฎุฑูุฌ ูู ุจุงุทู ูุธุงูุฑ ุจููุฉ.
*   **ุถ (ุงูุถุงุฏ):** ุถุบุทุ ุงูุถุบุงุทุ ุซููุ ุงุญุชูุงุก ููู (ูุซู ุงูุฃุฑุถ).
*   **ุท (ุงูุทุงุก):** ูุทุกุ ุฅุญุงุทุฉ ุนููุงุ ุณููุ ุทุงูุฉ ูููููุฉ.
*   **ุธ (ุงูุธุงุก):** ุธููุฑุ ุธูุ ุญูุงูุฉุ ูุนุงุก ุธุงูุฑู.
*   **ุน (ุงูุนูู):** ุนููุ ูุจุนุ ูุนุงุกุ ุนููุ ุฅุฏุฑุงู (ูู ุงูุนูู).
*   **ุบ (ุงูุบูู):** ุบูุจุ ุบุทุงุกุ ุบููุถุ ุชุบุทูุฉุ ูุง ูุง ูุฏุฑู ุจุงูุญูุงุณ.
*   **ู (ุงููุงุก):** ุงููุชุงุญุ ุชูุฑูุบุ ุชูููุณุ ูุฑุฌุ ููุงู.
*   **ู (ุงููุงู):** ููุฉุ ูุงูููุ ููุงูุจุ ููุงูุฉุ ุซููุ ุงุตุทุฏุงู (ููููุฉ).
*   **ู (ุงููุงู):** ูุจุญุ ูุณูุ ููููุฉุ ุชููููุ ูููููุฉ (ุชุญููู ุงูุทุงูุฉ ููุงุฏุฉ).
*   **ู (ุงููุงู):** ูุตูุ ูุตูุ ุชูุฌููุ ุญุฑูุฉ ูููุฉุ ุฅูุตุงู ุดูุก ูุดูุก.
*   **ู (ุงูููู):** ููุงูุ ุฌูุนุ ูููุ ุฅุชูุงูุ ูุญูุทุ ูุจุณููุฉ.
*   **ู (ุงูููู):** ููุงุฉุ ูููููุฉ ุฏุงุฎููุฉุ ุงุณุชูุฑุงุฑุ ุจุงุทู ุงูุดูุก.
*   **ูู (ุงููุงุก):** ูููุฉุ ุชูุฌูู ูุงุนูุ ูุดุงุดุฉุ ููุงุกุ ุญูุงุฉ (ููุณ).
*   **ู (ุงููุงู):** ูุตูุ ุฌูุนุ ูุฏุ ุชูููุฉุ ุงุณุชูุฑุงุฑ.
*   **ู (ุงููุงุก):** ูุฏุ ููููุ ููุฉ ูุงุนูุฉุ ุชูููุ ุณูุทุฑุฉ.

---
### ุฑุงุจุนุงู: ุจุฑูุชูููู ุงูุฅุฌุงุจุฉ (ุฎุทูุงุช ุงูุชูููุฐ):
1.  **ูุฑุงุกุฉ ุชูุฑูุฑ ุงููููู ุงููุตุตู (ุฅู ูุฌุฏ):** ุงููู ุงููุฑุญูุฉ ุงูุฒูููุฉ (ุงุณุชุถุนุงู/ุชูููู/ููุงุฌูุฉ) ูุชุจูู ุนูููุง ุงููุนูู.
2.  **ูุฑุงุกุฉ ุงููุณุญ ุงููุบูู:** ุงูุธุฑ ููุขูุงุช ุงููุฑููุฉ. ูุง ูู "ุงููุนู ุงูููุฒูุงุฆู ุงููุดุชุฑู" ูููููุฉุ
3.  **ุงูุชูููู ุงูุตูุชู:** ููู ุงููููุฉ ูุฃุตูุงุชูุง ุจูุงุกู ุนูู ุงููุนุฌู ุฃุนูุงู.
4.  **ุงูุตูุงุบุฉ:** ูุบุฉ ุนูููุฉุ ูุญุงูุฏุฉุ ุนูููุฉุ ุชุฑูุถ ุงูุชุฑุงุฏู. ุงุจุฏุฃ ุจู: "ูููุงู ูููุฒูุงุก ุงููุณุงู ุงูุนุฑุจู ุงููุจูู..."
"""

# ==========================================
# 3. ุงูููุทู ุงูุฑุฆูุณู (The Brain Logic)
# ==========================================

with st.sidebar:
    st.header("ุฅุนุฏุงุฏุงุช ุงูุงุชุตุงู")
    api_key = st.text_input("ุฃุฏุฎู ููุชุงุญ Google API (Gemini)", value="AIzaSyDj3w8h2E8f_BWzZC-YbeHkQEfryq-Sp5s", type="password")
    st.info("๐ก ูุฐุง ุงููููู ูุฏูุฌ: 1. ุชุญููู ููุฒูุงุก ุงูุญุฑู (ูู ุงููุชุงุจ) + 2. ุงููุณุญ ุงููุฑุขูู ุงูุดุงูู + 3. ุชุฑุชูุจ ุงูุณูุงู ุงููุตุตู.")

# ุชููุฆุฉ ุณุฌู ุงููุญุงุฏุซุฉ
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []

# ุนุฑุถ ุงููุญุงุฏุซุฉ ุงูุณุงุจูุฉ
for msg in st.session_state.chat_history:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# ุงุณุชูุจุงู ุงูุณุคุงู
if prompt := st.chat_input("ุงูุชุจ ุณุคุงูู ุงููุฑุขูู..."):
    
    if not api_key:
        st.error("ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุชุงุญ API ุฃููุงู.")
        st.stop()
        
    # ุชุณุฌูู ุฑุณุงูุฉ ุงููุณุชุฎุฏู
    st.session_state.chat_history.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        container = st.empty()
        status_box = container.status("โ๏ธ ุชุดุบูู ุงููุญุฑูุงุช ุงููุนุฑููุฉ...", expanded=True)
        
        try:
            genai.configure(api_key=api_key)
            # ูุณุชุฎุฏู ุงููููุฐุฌ ุงูุฃููู ููุชุนุงูู ูุน ุงูุณูุงู ุงูุทููู ูุงูุชุนูููุงุช ุงููุนูุฏุฉ
            model = genai.GenerativeModel('gemini-3-pro-preview')
            
            # ---------------------------------------------------------
            # ุงููุฑุญูุฉ ุฃ: ูุญุต ุงูุณูุงู ุงููุตุตู (ุงุณุชุฏุนุงุก ุงููููู ุงูุซุงูู)
            # ---------------------------------------------------------
            status_box.write("๐ต๏ธโโ๏ธ ูุญุต ุงูุณูุงู: ูู ุงูุขูุฉ ูุฑุชุจุทุฉ ุจูุตุฉ ูุจูุ")
            check_prophet_prompt = f"ูู ูุชุญุฏุซ ูุฐุง ุงููุต: '{prompt}' ุนู ูุจู ุฃู ุฑุณูู ูุญุฏุฏุ ุฃุฌุจ ุจุงูุงุณู ููุท. ุฅุฐุง ูู ููุฌุฏุ ุงูุชุจ 'ูุง'."
            prophet_name = model.generate_content(check_prophet_prompt).text.strip()
            
            story_context_report = ""
            if "ูุง" not in prophet_name and len(prophet_name) < 20:
                status_box.write(f"๐ ุชู ุฑุตุฏ ุณูุงู ูุตุตู ูููุจู: {prophet_name}")
                status_box.write("โณ ุงุณุชุฏุนุงุก 'ุงููููุฏุณ ุงููุตุตู' ูุชุฑุชูุจ ุงูุฃุญุฏุงุซ ุฒูููุงู...")
                
                # ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงููููู ุงููุตุตู ูู ุงูููู ุงููููุตู
                story_context_report = story_agent.run_story_agent(model, prophet_name, prompt)
                
                if story_context_report:
                    status_box.write("โ ุชู ุงุณุชูุงู ุชูุฑูุฑ ุงูุณูุงู ุงูุฒููู.")
            else:
                status_box.write("โน๏ธ ุชุญููู ุณูุงูู ุนุงู (ุจุฏูู ุชุฑุชูุจ ูุตุตู).")

            # ---------------------------------------------------------
            # ุงููุฑุญูุฉ ุจ: ุงุณุชุฎุฑุงุฌ ุงูุฌุฐูุฑ ูุงููุณุญ (ุฃุฏูุงุช ุงูุจุญุซ)
            # ---------------------------------------------------------
            status_box.write("๐ ุงุณุชุฎุฑุงุฌ ุงูุฌุฐูุฑ ุงููุบููุฉ ูููููุงุช ุงููุญูุฑูุฉ...")
            root_extraction_prompt = f"""
            ุงุณุชุฎุฑุฌ "ุงูุฌุฐูุฑ ุงูุซูุงุซูุฉ" (Roots) ูููููุงุช ุงููุฑุขููุฉ ุงูุฃูู ูู ุงูุณุคุงู ุงูุชุงูู: "{prompt}"
            - ุชุฌุงูู ุงููููุงุช ุงูุดุงุฆุนุฉ.
            - ุฃุฎุฑุฌ ุงููุชูุฌุฉ ููุงุฆูุฉ ููุตููุฉ ุจููุงุตู ููุท (ูุซุงู: ูุชุจ, ูุฑุฃ).
            """
            roots_raw = model.generate_content(root_extraction_prompt).text
            # ุชูุธูู ุงููุงุฆูุฉ
            roots = [r.strip() for r in roots_raw.replace("ุ", ",").split(",") if len(r.strip()) >= 3]
            
            search_report = ""
            if roots:
                status_box.write(f"โ ุงูุฌุฐูุฑ ุงููุณุชูุฏูุฉ: {roots}")
                status_box.write("๐ ุฅุฌุฑุงุก ูุณุญ ุงุณุชูุฑุงุฆู ูู ูุงูู ุงููุตุญู...")
                # ุงุณุชุฏุนุงุก ุฃุฏุงุฉ ุงูุจุญุซ ูู ุงูููู ุงููููุตู
                search_report = search_multi_roots_tool(roots)
                status_box.write("โ ุชู ุงุณุชุฏุนุงุก ุงูุดูุงูุฏ ุงููุฑุขููุฉ.")

            # ---------------------------------------------------------
            # ุงููุฑุญูุฉ ุฌ: ุงูุชุญููู ุงูููุงุฆู (ุงูุชูููุฑ ูุงูุชุฑููุจ)
            # ---------------------------------------------------------
            status_box.write("๐ง ุฌุงุฑู ุงูุชูููู ุงูููุฒูุงุฆู ูุงูุฑุจุท ุงููููู...")
            
            final_input = f"""
            {ANALYST_PROMPT}
            
            ---
            ### 1. ุชูุฑูุฑ ุงูุณูุงู ุงููุตุตู (ูู ุงููููุฏุณ ุงููุตุตู):
            {story_context_report if story_context_report else "ูุง ููุฌุฏ ุณูุงู ูุตุตู ุฎุงุตุ ุงุนุชูุฏ ุนูู ุงูุณูุงู ุงูุนุงู."}
            
            ### 2. ุชูุฑูุฑ ุงููุณุญ ุงููุบูู (ุงููุฑุขู ููุณุฑ ุจุนุถู):
            {search_report}
            ---
            
            ### ุณุคุงู ุงููุณุชุฎุฏู: 
            {prompt}
            """
            
            # ุงุณุชุฏุนุงุก ุงููููุฐุฌ ููุฅุฌุงุจุฉ ุงูููุงุฆูุฉ
            response_stream = model.generate_content(final_input, stream=True)
            
            status_box.update(label="ุงูุชูู ุงูุชุญููู", state="complete", expanded=False)
            
            # ุนุฑุถ ุงููุชูุฌุฉ ุจุชุฏูู
            full_response = ""
            response_placeholder = st.empty()
            for chunk in response_stream:
                full_response += chunk.text
                response_placeholder.markdown(full_response + "โ")
            response_placeholder.markdown(full_response)
            
            # ุญูุธ ูู ุงูุฐุงูุฑุฉ
            st.session_state.chat_history.append({"role": "assistant", "content": full_response})

        except Exception as e:
            status_box.update(label="ุญุฏุซ ุฎุทุฃ", state="error")
            st.error(f"ุชูุงุตูู ุงูุฎุทุฃ: {e}")